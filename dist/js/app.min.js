function alertFty($sce,$timeout){var factory={showMessage:!1,messageContent:"",displayMessage:function(mContent){$timeout.cancel(factory.messageTimer),mContent=mContent||"Nope.",factory.messageContent=mContent,factory.showMessage=!0,factory.messageTimer=$timeout(factory.hideMessage,9e3)},hideMessage:function(){factory.showMessage=!1},messageTimer:null,showModal:!1,modalContent:{},defaultModal:{buttonText:"Cool",content:[{title:"Error?",text:["Something went wrong."]}]},invalidUrlModal:{buttonText:"Fine",content:[{title:"Invalid URL",text:["Your URL parameters are invalid. I'm ignoring them."]}]},destinationsMergedModal:{buttonText:"Lame",content:[{title:"Destinations Merged",text:["I merged some of your destinations because they were too close."]}]},destinationsNotFoundModal:{buttonText:"Fine",content:[{title:"Destinations Skipped",text:["I skipped some of your destinations because I couldn't find them."]}]},dateRangeInvalidModal:{buttonText:"Fine",content:[{title:"Date Ranges Invalid",text:["Some of your date ranges were invalid, so I skipped them."]}]},aboutModal:{buttonText:"Ok, whatever",content:[{title:"What is this?",text:["Travel Weathr allows you to build a weather forecast calendar for all of your vacation destinations with varied arrivals and departures.","Create a trip by adding destinations with arrival and departure dates, then bookmark the link or share it with the people you'll be travelling with. Every time you visit the link, your freshly updated forecast will be shown."]},{title:"Who provides the data?",text:['<a href="https://developer.forecast.io/">Dark Sky</a> provides the weather data, and <a href="https://developers.google.com/maps/">Google</a> provides the map and location data.']},{title:"I found a bug.",text:['Ew, just squish it. Or report it on the <a href="https://github.com/ejsado/travel-forecast/issues">github page</a>.']},{title:"What else you got?",text:['You can find my other projects on <a href="http://www.ericsadowski.com/">my website</a>. Or you can take a look at <a href="http://codepen.io/ejsado/">my codepen profile</a> for my code demos.']}]},trustDialogText:function(mContent){mContent=mContent||factory.defaultModal;for(var i=0;i<mContent.content.length;i++)for(var n=0;n<mContent.content[i].text.length;n++)mContent.content[i].text[n]=$sce.trustAsHtml(mContent.content[i].text[n]);return mContent},hideModal:function(){factory.showModal=!1},displayModal:function(mContent){mContent=mContent||factory.defaultModal,factory.modalContent=mContent,factory.showModal=!0}};return factory.trustDialogText(factory.defaultModal),factory.trustDialogText(factory.invalidUrlModal),factory.trustDialogText(factory.destinationsMergedModal),factory.trustDialogText(factory.destinationsNotFoundModal),factory.trustDialogText(factory.dateRangeInvalidModal),factory.trustDialogText(factory.aboutModal),factory.modalContent=factory.defaultModal,factory}function appCtrl($timeout,$scope,locationFty,destinationFty,forecastFty,dateFty,urlFty,distanceFty,alertFty){function getDataFromUrl(){function delayLoadDestination(latLng,dateRangeList,delay,count){$timeout(function(){locationFty.geocodeLatLng(latLng,function(result){console.log("coords found");for(var n=0;n<dateRangeList.length;n++)dateFty.validDate(dateRangeList[n].arrival)&&dateFty.validDate(dateRangeList[n].departure)&&dateFty.datesWithinDays(dateRangeList[n].arrival,dateRangeList[n].departure,dateFty.maxDateRange)?(dateRangeList[n].arrival<dateFty.today&&(dateRangeList[n].arrival=new Date(dateFty.today)),dateRangeList[n].departure<dateFty.today&&(dateRangeList[n].departure=new Date(dateFty.today)),dateRangeList[n].arrival>dateRangeList[n].departure?destinationFty.addDestination(result,dateRangeList[n].departure,dateRangeList[n].arrival):destinationFty.addDestination(result,dateRangeList[n].arrival,dateRangeList[n].departure),forecastFty.attemptGetForecast(result.coords.lat,result.coords.lng,result.name)):(console.log("destination date range invalid"),dateRangeInvalid=!0);destinationFty.destinationList.length>1&&distanceFty.attemptGetDistance(destinationFty.destinationList[destinationFty.destinationList.length-2],destinationFty.destinationList[destinationFty.destinationList.length-1],function(){}),count==urlDestinations.length&&(self.loadingDestinations=!1,console.log("done loading destinations"),count!=destinationFty.destinationList.length&&(destinationsNotFound?alertFty.displayModal(alertFty.destinationsNotFoundModal):dateRangeInvalid?alertFty.displayModal(alertFty.dateRangeInvalidModal):alertFty.displayModal(alertFty.destinationsMergedModal)),urlFty.buildUrlParamTrip(destinationFty.destinationList),$scope.$apply())},function(result){console.log("coords unknown, skipping location"),destinationsNotFound=!0})},delay)}forecastFty.units=urlFty.getUrlUnits();var urlDestinations=[];urlFty.validUrlParamTrip()?urlDestinations=urlFty.getUrlDestinations():(console.log("invalid url"),alertFty.displayModal(alertFty.invalidUrlModal)),urlDestinations.length>0?self.loadingDestinations=!0:urlFty.buildUrlParamUnits(forecastFty.units);var timeDelay=1e3;destinationFty.clearDestinations();for(var destinationsNotFound=!1,dateRangeInvalid=!1,i=0;i<urlDestinations.length;i++){var latLng=new google.maps.LatLng({lat:urlDestinations[i].coords.lat,lng:urlDestinations[i].coords.lng});delayLoadDestination(latLng,urlDestinations[i].dateRanges,timeDelay*i,i+1)}urlDestinations.length>=1&&locationFty.map.panTo(new google.maps.LatLng({lat:urlDestinations[0].coords.lat,lng:urlDestinations[0].coords.lng}))}angular.element(document).ready(function(){});var self=this;self.locationFty=locationFty,self.destinationFty=destinationFty,self.forecastFty=forecastFty,self.dateFty=dateFty,self.urlFty=urlFty,self.distanceFty=distanceFty,self.alertFty=alertFty,self.highlightInput=function(e){e.target.select()},self.clear=function(){destinationFty.clearDestinations(),urlFty.clearUrlParamTrip(),urlFty.buildUrlParamUnits(forecastFty.units)},self.loadingDestinations=!1,getDataFromUrl(),$scope.$on("$locationChangeSuccess",function(event,url){console.log("url param changed"),urlFty.paramsUpdated||(console.log("external url change"),getDataFromUrl()),urlFty.buildShortUrl(),urlFty.paramsUpdated=!1})}function calendarCtrl($scope,destinationFty,urlFty,locationFty,dateFty,forecastFty,distanceFty){var self=this;self.selectedDate=new Date(dateFty.today),self.setSelectedDate=function(date){self.selectedDate=date},self.removeSingleDestination=function(index){destinationFty.removeDestination(index),dateFty.buildDateList(destinationFty.destinationList),urlFty.buildUrlParamTrip(destinationFty.destinationList),locationFty.buildMapMarkers(destinationFty.destinationList),destinationFty.destinationList.length>1&&index>0&&index<destinationFty.destinationList.length&&distanceFty.attemptGetDistance(destinationFty.destinationList[index-1],destinationFty.destinationList[index],function(){$scope.$apply()})}}function dateFty($filter){var factory={dateList:[],setCommonTime:function(d){var dateObj=new Date(d);return dateObj.setHours(6),dateObj.setMinutes(0),dateObj.setSeconds(0),dateObj.setMilliseconds(0),dateObj},today:new Date((new Date).setHours(6,0,0,0)),maxDate:new Date("December 31, 2050"),maxDateRange:30,datesEqual:function(date1,date2){return Math.abs(date1.getTime()-date2.getTime())<288e5},datesWithinDays:function(date1,date2,days){return Math.abs(date1.getTime()-date2.getTime())<864e5*days+288e5},validDate:function(d){return null!=d&&d<factory.maxDate},createDateString:function(dateObj){return $filter("date")(dateObj,"MMddyy")},createDateFromString:function(dateStr){if(6==dateStr.length){var d=new Date,year=Number(dateStr.substr(4,2))+2e3,month=Number(dateStr.substr(0,2))-1,day=Number(dateStr.substr(2,2));return d.setFullYear(year,month,day),d=factory.setCommonTime(d)}return null},buildDateList:function(destinationList){for(var newDateList=[],i=0;i<destinationList.length;i++)newDateList.push.apply(newDateList,destinationList[i].dates);newDateList=factory.removeDuplicateDates(newDateList),newDateList.sort(factory.dateCompare),factory.dateList=factory.groupDates(newDateList),console.log("date list",factory.dateList)},groupDates:function(dList){var groupedDates=[[]];groupedDates[0].push(dList[0]);for(var n=0,i=1;i<dList.length;i++)factory.consecutiveDates(dList[i-1],dList[i])?groupedDates[n].push(dList[i]):(n++,groupedDates[n]=[],groupedDates[n].push(dList[i]));return groupedDates},createDateRanges:function(dList){for(var dateRanges=[],arrive=dList[0],depart=dList[dList.length-1],i=1;i<dList.length;i++)factory.consecutiveDates(dList[i-1],dList[i])||(dateRanges.push({arrival:arrive,departure:dList[i-1]}),arrive=dList[i]);return dateRanges.push({arrival:arrive,departure:depart}),dateRanges},dateInArray:function(d,array){for(var i=0;i<array.length;i++)if(factory.datesEqual(d,array[i]))return!0;return!1},enumerateDateRange:function(start,end){for(var enumDates=[],d=new Date(start);d<end;d.setDate(d.getDate()+1))enumDates.push(new Date(d));return enumDates.push(new Date(end)),enumDates},dateDuplicate:function(item,index,array){for(var i=index+1;i<array.length;i++)if(factory.datesEqual(item,array[i]))return!1;return!0},removeDuplicateDates:function(dateArray){return dateArray.filter(factory.dateDuplicate)},dateCompare:function(a,b){return a.getTime()-b.getTime()},consecutiveDates:function(date1,date2){var d=new Date(date1);return d.setDate(d.getDate()+1),!!factory.datesEqual(d,date2)},crossReferenceDates:function(destinationDates,destinationForecast){var forecastDates=[];for(var item in destinationForecast)forecastDates.push(factory.createDateFromString(item));for(var remainingDates=[],i=0;i<destinationDates.length;i++)factory.dateInArray(destinationDates[i],forecastDates)||remainingDates.push(new Date(destinationDates[i]));return remainingDates}};return factory}function destinationFty(dateFty,urlFty,locationFty,alertFty){var factory={destinationList:[],addDestination:function(place,arrival,departure){for(var destAdded=!1,i=0;i<factory.destinationList.length;i++)if(place.name==factory.destinationList[i].name){if(console.log("destination exists"),!dateFty.datesWithinDays(factory.destinationList[i].dates[0],departure,dateFty.maxDateRange))return console.log("destination date range greater than 30 days"),alertFty.displayMessage("Staying for more than "+dateFty.maxDateRange+" days? That's absurd."),destAdded;factory.destinationList[i].dates.push.apply(factory.destinationList[i].dates,dateFty.enumerateDateRange(arrival,departure)),factory.destinationList[i].dates=dateFty.removeDuplicateDates(factory.destinationList[i].dates),factory.destinationList[i].dates.sort(dateFty.dateCompare),factory.destinationList[i].dateRanges=dateFty.createDateRanges(factory.destinationList[i].dates),destAdded=!0,alertFty.displayMessage("This destination exists, so I merged the dates.")}return factory.destinationList.length>10?(console.log("maximum destinations reached"),alertFty.displayMessage("More than 10 destinations? That's ridiculous."),destAdded):(destAdded||(factory.destinationList.push({name:place.name,coords:place.coords,dates:dateFty.enumerateDateRange(arrival,departure),dateRanges:[{arrival:arrival,departure:departure}]}),console.log("new destination added"),destAdded=!0),factory.destinationList.sort(factory.destinationCompare),locationFty.buildMapMarkers(factory.destinationList),dateFty.buildDateList(factory.destinationList),destAdded)},removeDestination:function(indexToRemove,rebuild){factory.destinationList.splice(indexToRemove,1),rebuild&&(factory.destinationList.sort(factory.destinationCompare),locationFty.buildMapMarkers(factory.destinationList),dateFty.buildDateList(factory.destinationList))},getDestinationByName:function(name){for(var i=0;i<factory.destinationList.length;i++)if(name==factory.destinationList[i].name)return factory.destinationList[i];return null},getDestinationIndexByName:function(name){for(var i=0;i<factory.destinationList.length;i++)if(name==factory.destinationList[i].name)return i;return null},destinationCompare:function(a,b){return a.dates[a.dates.length-1].getTime()-b.dates[b.dates.length-1].getTime()},clearDestinations:function(){for(var len=factory.destinationList.length,i=0;i<len;i++)i==len-1?factory.removeDestination(0,!0):factory.removeDestination(0,!1);console.log("destination list",factory.destinationList)}};return factory}function distanceFty(){var factory={distanceList:{},distanceMatrix:new google.maps.DistanceMatrixService,attemptGetDistance:function(destination1,destination2,callback){null!=factory.distanceList[destination1.name]&&null!=factory.distanceList[destination1.name][destination2.name]?console.log("distance exists"):factory.getDistance(destination1,destination2,callback)},getDistance:function(destination1,destination2,callback){var origin=new google.maps.LatLng(destination1.coords.lat,destination1.coords.lng),destination=new google.maps.LatLng(destination2.coords.lat,destination2.coords.lng);factory.distanceMatrix.getDistanceMatrix({origins:[origin],destinations:[destination],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL},function(response,status){factory.processDistanceMatrix(response,status,destination1.name,destination2.name),callback()})},processDistanceMatrix:function(response,status,fromName,toName){status==google.maps.DistanceMatrixStatus.OK?(null==factory.distanceList[fromName]&&(factory.distanceList[fromName]={}),response.rows[0].elements[0].status==google.maps.DistanceMatrixStatus.OK?factory.distanceList[fromName][toName]={distance:response.rows[0].elements[0].distance,duration:response.rows[0].elements[0].duration}:factory.distanceList[fromName][toName]={distance:{text:"Unknown distance",value:0},duration:{text:"Unknown travel time",value:0}},console.log("distance matrix results",response)):console.log("distance matrix failed")}};return factory}function forecastFty($http,$timeout,dateFty,destinationFty){var factory={forecastList:{},units:"imperial",convertDegrees:function(degrees){if(null!=degrees&&void 0!=degrees)return"metric"==factory.units?Math.round((degrees-32)*(5/9)):degrees},getHttpForecast:function(url,data,successFn,failureFn){console.log("http forecast",url),$http.get(url).then(function(response){successFn(response,data)},function(response){failureFn(response,data)})},getPhpForecast:function(url,data,successFn,failureFn){console.log("php forecast"),$http({method:"POST",url:url,data:data,transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(response){successFn(response,data)},function(response){failureFn(response,data)})},darkSkyForecast:function(data){factory.getPhpForecast("/scripts/darkSkyWeather.php",data,function(response,data){console.log("dark sky response",response),factory.forecastList[data.name]=factory.processDarkSkyForecast(response),console.log("forecastList",factory.forecastList);var dest=destinationFty.getDestinationByName(data.name);null!=dest&&factory.getExtendedForecast(data,dateFty.crossReferenceDates(dest.dates,factory.forecastList[data.name]))},function(response,data){console.log("Dark Sky forecast response failed"),factory.forecastList[data.name]=null})},attemptGetForecast:function(lat,lng,name){if(null==factory.forecastList[name])factory.darkSkyForecast({lat:lat,lng:lng,name:name});else{console.log("forecast exists");var dest=destinationFty.getDestinationByName(name);null!=dest&&factory.getExtendedForecast({lat:lat,lng:lng,name:name},dateFty.crossReferenceDates(dest.dates,factory.forecastList[name]))}},getExtendedForecast:function(data,dateList){function delayRequest(date,delay){$timeout(function(){factory.getPhpForecast("/scripts/darkSkyWeather.php",{lat:data.lat,lng:data.lng,name:data.name,date:Math.round(date.getTime()/1e3)},function(response,data){console.log(response),factory.forecastList[data.name][dateFty.createDateString(date)]=factory.processDarkSkyTimeMachine(response),console.log("forecastList",factory.forecastList)},function(response,data){console.log("Dark Sky time machine response failed")})},delay)}for(var timeDelay=500,i=0;i<dateList.length;i++)delayRequest(dateList[i],timeDelay*(i+1));return timeDelay*dateList.length},processDarkSkyForecast:function(response){for(var forecast={},i=0;i<response.data.daily.data.length;i++){var dateStr=dateFty.createDateString(new Date(1e3*response.data.daily.data[i].time));forecast[dateStr]=forecast[dateStr]||{},forecast[dateStr].high=Math.round(response.data.daily.data[i].temperatureMax),forecast[dateStr].precip=Math.round(100*response.data.daily.data[i].precipProbability),forecast[dateStr].text=response.data.daily.data[i].summary,forecast[dateStr].low=Math.round(response.data.daily.data[i].temperatureMin),forecast[dateStr].icon=response.data.daily.data[i].icon}return forecast},processDarkSkyTimeMachine:function(response){var forecast={};return forecast.high=Math.round(response.data.daily.data[0].temperatureMax),"precipProbability"in response.data.daily.data[0]?forecast.precip=Math.round(100*response.data.daily.data[0].precipProbability):forecast.precip=0,forecast.text=response.data.daily.data[0].summary,forecast.low=Math.round(response.data.daily.data[0].temperatureMin),forecast.icon=response.data.daily.data[0].icon,forecast}};return factory}function formCtrl($scope,destinationFty,forecastFty,dateFty,urlFty,distanceFty,alertFty){function updateStartDate(){self.startDate=dateFty.setCommonTime(pickStartDate.getDate());var d=new Date(self.startDate);d.setDate(d.getDate()+dateFty.maxDateRange),pickEndDate.setMinDate(self.startDate),pickEndDate.setMaxDate(d),pickEndDate.getDate()<self.startDate?(pickEndDate.setDate(self.startDate),self.endDate=new Date(self.startDate)):pickEndDate.getDate()>d&&(pickEndDate.setDate(d),self.endDate=new Date(d)),self.showStartDatePicker=!1,$scope.$apply()}function updateEndDate(){self.endDate=dateFty.setCommonTime(pickEndDate.getDate()),self.showEndDatePicker=!1,$scope.$apply()}var self=this;self.startDate=new Date(dateFty.today),self.endDate=new Date(dateFty.today),self.showStartDatePicker=!1,self.showEndDatePicker=!1;var pickStartDate=new Pikaday({field:document.getElementById("start-date"),bound:!1,container:document.getElementById("pikaday-start"),format:"MMM D, YYYY",defaultDate:dateFty.today,setDefaultDate:!0,minDate:dateFty.today,maxDate:dateFty.maxDate,onSelect:updateStartDate}),maxEndDate=dateFty.setCommonTime(new Date);maxEndDate.setDate(maxEndDate.getDate()+dateFty.maxDateRange);var pickEndDate=new Pikaday({field:document.getElementById("end-date"),bound:!1,container:document.getElementById("pikaday-end"),format:"MMM D, YYYY",defaultDate:dateFty.today,setDefaultDate:!0,minDate:dateFty.today,maxDate:maxEndDate,onSelect:updateEndDate});self.unitsChanged=function(){urlFty.buildUrlParamUnits(forecastFty.units)},self.attemptAddDestination=function(place,arrival,departure){if(null!=place.coords)if(dateFty.validDate(arrival)&&dateFty.validDate(departure)&&dateFty.datesWithinDays(arrival,departure,dateFty.maxDateRange)){if(arrival>departure?(destinationFty.addDestination(place,departure,arrival),console.log("switched dates"),alertFty.displayMessage("Your dates were backwards, so I switched them for you.")):destinationFty.addDestination(place,arrival,departure),forecastFty.attemptGetForecast(place.coords.lat,place.coords.lng,place.name),destinationFty.destinationList.length>1){var destIndex=destinationFty.getDestinationIndexByName(place.name);destIndex<destinationFty.destinationList.length-1&&distanceFty.attemptGetDistance(destinationFty.destinationList[destIndex],destinationFty.destinationList[destIndex+1],function(){$scope.$apply()}),destIndex>0&&distanceFty.attemptGetDistance(destinationFty.destinationList[destIndex-1],destinationFty.destinationList[destIndex],function(){$scope.$apply()})}urlFty.buildUrlParamTrip(destinationFty.destinationList),console.log("destination list",destinationFty.destinationList),console.log("date list",dateFty.dateList)}else alertFty.displayMessage("Nah, those dates don't work for me. Try again.");else alertFty.displayMessage("That place doesn't exist.")}}function locationFty(){var factory={geocoder:new google.maps.Geocoder,map:new google.maps.Map(document.getElementById("map"),{zoom:4,center:{lat:38.50949,lng:-96.767578},clickableIcons:!1}),markerList:[],locationDetails:{name:"Search for a location or select one on the map",coords:null},validLat:function(lat){return-90<=lat<=90},validLng:function(lng){return-180<=lat<=180},createLocationDetails:function(address,latLng){var loc={name:address};return latLng?loc.coords={lat:latLng.lat(),lng:latLng.lng()}:loc.coords=null,loc},buildMapMarkers:function(destList){for(var i=0;i<factory.markerList.length;i++)factory.markerList[i].setMap(null);factory.markerList=[];for(var i=0;i<destList.length;i++){var marker=new google.maps.Marker({position:destList[i].coords,map:factory.map,title:destList[i].name,label:{text:String(i+1),color:"white"},icon:{path:google.maps.SymbolPath.CIRCLE,clickable:!1,fillColor:"blue",fillOpacity:100,strokeColor:"white",strokeWeight:2,scale:11}});factory.markerList.push(marker)}},geocodeAddress:function(address,successCallback,errorCallback){factory.geocoder.geocode({address:address},angular.bind(this,function(results,status){if(status===google.maps.GeocoderStatus.OK){console.log("address found",results[0]);var locDetails=factory.createLocationDetails(results[0].formatted_address,results[0].geometry.location);successCallback(locDetails)}else{console.log("Geocode address failed: "+status);var locDetails=factory.createLocationDetails("Location not found. Try selecting it on the map.",null);errorCallback(locDetails)}}))},geocodeLatLng:function(latLng,successCallback,errorCallback){factory.geocoder.geocode({location:latLng},function(results,status){if(status===google.maps.GeocoderStatus.OK){console.log("location found",results);for(var resultMatch,i=0;i<results.length;i++)if(results[i].address_components.length<=5&&!results[i].formatted_address.includes("Township")){resultMatch=results[i];break}var locDetails=factory.createLocationDetails(resultMatch.formatted_address,resultMatch.geometry.location);successCallback(locDetails)}else{console.log("Geocode latLng failed: "+status);var locDetails=factory.createLocationDetails("Unknown location",null);errorCallback(locDetails)}})}};return factory}function mapCtrl($scope,$timeout,locationFty){function removeMarker(){marker&&(marker.setMap(null),marker=null)}function replaceMapMarker(map,position){console.log("replace marker"),removeMarker(),marker=new google.maps.Marker({map:map,position:position,zIndex:100})}function centerMap(map,position){console.log("center map"),map.panTo(position)}function zoomMap(map,zoomLevel){map.setZoom(zoomLevel)}function addressFound(result){console.log("address found"),locationFty.locationDetails=result,centerMap(locationFty.map,result.coords),zoomMap(locationFty.map,10),replaceMapMarker(locationFty.map,result.coords),$scope.$apply()}function addressNotFound(result){console.log("address not found"),locationFty.locationDetails=result,removeMarker(),$scope.$apply()}function coordsFound(result){console.log("coords found"),locationFty.locationDetails=result,$scope.$apply()}function coordsUnknown(result){console.log("coords unknown",result),locationFty.locationDetails=result,$scope.$apply()}var self=this,marker=null,throttle=!1;self.locationSearch=function(query){query.length>3&&(console.log("search for "+query),locationFty.geocodeAddress(query,addressFound,addressNotFound))},locationFty.map.addListener("click",function(e){throttle||(throttle=!0,replaceMapMarker(locationFty.map,e.latLng),locationFty.geocodeLatLng(e.latLng,coordsFound,coordsUnknown),$timeout(function(){throttle=!1},1e3))})}function urlFty($timeout,$location,$http,dateFty,locationFty){var factory={paramsUpdated:!0,shortUrl:"for bookmarking",getUrlUnits:function(){var urlParams=$location.search(),param=urlParams.u;return"c"==param||"C"==param?"metric":"imperial"},buildUrlParamUnits:function(units){var newUnits="f";"metric"==units&&(newUnits="c"),console.log("add url units"),factory.paramsUpdated=!0,$location.search("u",newUnits)},clearUrlParamTrip:function(){factory.paramsUpdated=!0,$location.search("t")},validUrlParamTrip:function(){var urlParams=$location.search(),param=urlParams.t;if(param||void 0==param)return!0;var forecastArray=param.split("d");if(forecastArray.length<2)return!1;for(var i=1;i<forecastArray.length;i++){var propertiesArray=forecastArray[i].split("r"),coordsArray=propertiesArray[0].split("l");if(2!=coordsArray.length||!locationFty.validLat(Number(coordsArray[0]))||!locationFty.validLng(Number(coordsArray[1])))return!1;for(var n=1;n<propertiesArray.length;n++){var dateRangeArray=propertiesArray[n].split("e");if(2!=dateRangeArray.length||!dateFty.validDate(dateFty.createDateFromString(dateRangeArray[0]))||!dateFty.validDate(dateFty.createDateFromString(dateRangeArray[1])))return!1}}return!0},createDestinationString:function(lat,lng,dateRangeList){var str="d";str+=String(lat),str+="l",str+=String(lng);for(var i=0;i<dateRangeList.length;i++)str+="r",str+=dateFty.createDateString(dateRangeList[i].arrival),str+="e",str+=dateFty.createDateString(dateRangeList[i].departure);return str},buildUrlParamTrip:function(destinationList){for(var url="",i=0;i<destinationList.length;i++)url+=factory.createDestinationString(destinationList[i].coords.lat,destinationList[i].coords.lng,destinationList[i].dateRanges);""==url?factory.clearUrlParamTrip():(factory.paramsUpdated=!0,$location.search("t",url))},getUrlDestinations:function(){var urlParams=$location.search(),param=urlParams.t,destList=[];if(param===!0||void 0==param)return destList;for(var forecastArray=param.split("d"),i=1;i<forecastArray.length;i++){var propertiesArray=forecastArray[i].split("r"),coordsArray=propertiesArray[0].split("l");destList[i-1]={coords:{lat:Number(coordsArray[0]),lng:Number(coordsArray[1])},dateRanges:[]};for(var n=1;n<propertiesArray.length;n++){var dateRangeArray=propertiesArray[n].split("e");destList[i-1].dateRanges.push({arrival:dateFty.createDateFromString(dateRangeArray[0]),departure:dateFty.createDateFromString(dateRangeArray[1])})}}return console.log("url destinations",destList),destList},createDirectionsUrl:function(destinationsArray){var url="";if(destinationsArray.length>1){url="https://www.google.com/maps/dir";for(var i=0;i<destinationsArray.length;i++){if(void 0==destinationsArray[i]||null==destinationsArray[i])return"";url+="/"+destinationsArray[i].coords.lat+",",url+=destinationsArray[i].coords.lng}return url}if(url="https://www.google.com/maps/place/",void 0!=destinationsArray[0]&&null!=destinationsArray[0]){var placeName=destinationsArray[0].name;return placeName=placeName.split(" ").join("+"),placeName=placeName.split(",").join(""),url+=placeName}return""},shortUrlThrottle:!1,buildShortUrl:function(){factory.shortUrlThrottle||(factory.shortUrlThrottle=!0,$http.post("https://www.googleapis.com/urlshortener/v1/url?key="+googleKey,{longUrl:$location.absUrl()}).then(function(response){console.log("short url response",response),"id"in response.data&&(factory.shortUrl=response.data.id)},function(response){console.log("short url error",response)}),$timeout(function(){factory.shortUrlThrottle=!1},100))},getPageTitle:function(destList){var title="Travel Weathr";return destList.length>0&&(title+=" - "+destList[0].name),destList.length>1&&(title+=" to "+destList[destList.length-1].name),title}};return factory}